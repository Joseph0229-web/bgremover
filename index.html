<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 離線去背 (終極穩定版)</title>
    <script src="https://cdn.jsdelivr.net/npm/@imgly/background-removal@1.5.8/dist/browser.js"></script>
    <style>
        body { font-family: -apple-system, system-ui, sans-serif; background: #f4f7f6; display: flex; flex-direction: column; align-items: center; padding: 30px 20px; }
        .container { max-width: 650px; width: 100%; background: white; padding: 40px 30px; border-radius: 16px; box-shadow: 0 8px 30px rgba(0,0,0,0.08); text-align: center; }
        h2 { margin-top: 0; color: #2d3436; }
        p.subtitle { color: #636e72; font-size: 15px; margin-bottom: 25px; }
        .upload-area { border: 2px dashed #b2bec3; padding: 50px 20px; border-radius: 12px; cursor: pointer; transition: all 0.2s ease; background: #fafbfc; }
        .upload-area:hover { border-color: #0984e3; background: #f0f7ff; }
        #status { font-weight: bold; color: #0984e3; margin: 20px 0; min-height: 24px; font-size: 16px; }
        #progressBar { width: 100%; height: 8px; background: #dfe6e9; border-radius: 4px; overflow: hidden; display: none; margin-bottom: 20px; }
        #progressFill { width: 0%; height: 100%; background: #00b894; transition: width 0.3s; }
        .image-wrapper { margin-top: 20px; display: none; }
        img { max-width: 100%; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); background-image: conic-gradient(#eee 90deg, #fff 90deg 180deg, #eee 180deg 270deg, #fff 270deg); background-size: 20px 20px; }
        button { background: #00b894; color: white; border: none; padding: 14px 28px; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; display: none; margin-top: 20px; transition: background 0.2s; width: 100%; max-width: 300px; }
        button:hover { background: #00a080; }
    </style>
</head>
<body>

<div class="container">
    <h2>✨ AI 一鍵去背神器</h2>
    <p class="subtitle">圖片完全在您的裝置上處理，保障隱私，安全無憂</p>

    <div class="upload-area" id="dropZone">
        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#636e72" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom: 10px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
        <div style="font-size: 18px; color: #2d3436; font-weight: 500;">點擊或拖曳圖片至此處</div>
        <div style="font-size: 13px; color: #b2bec3; margin-top: 8px;">支援 JPG, PNG 格式</div>
    </div>
    <input type="file" id="fileInput" hidden accept="image/*">

    <div id="status"></div>
    
    <div id="progressBar"><div id="progressFill"></div></div>

    <div class="image-wrapper" id="imageWrapper">
        <img id="outputImage" alt="去背結果">
    </div>

    <a id="downloadLink" style="text-decoration:none;"><button id="saveBtn">⬇️ 下載去背圖片</button></a>
</div>

<script>
    const fileInput = document.getElementById('fileInput');
    const dropZone = document.getElementById('dropZone');
    const status = document.getElementById('status');
    const progressBar = document.getElementById('progressBar');
    const progressFill = document.getElementById('progressFill');
    const imageWrapper = document.getElementById('imageWrapper');
    const outputImage = document.getElementById('outputImage');
    const downloadLink = document.getElementById('downloadLink');
    const saveBtn = document.getElementById('saveBtn');

    // 點擊上傳
    dropZone.onclick = () => fileInput.click();

    // 拖曳上傳
    dropZone.ondragover = (e) => { e.preventDefault(); dropZone.style.borderColor = '#0984e3'; dropZone.style.background = '#f0f7ff'; };
    dropZone.ondragleave = () => { dropZone.style.borderColor = '#b2bec3'; dropZone.style.background = '#fafbfc'; };
    dropZone.ondrop = (e) => { e.preventDefault(); dropZone.style.borderColor = '#b2bec3'; dropZone.style.background = '#fafbfc'; handleFile(e.dataTransfer.files[0]); };

    fileInput.onchange = (e) => handleFile(e.target.files[0]);

    async function handleFile(file) {
        if (!file || !file.type.startsWith('image/')) {
            alert("請上傳有效的圖片檔案！");
            return;
        }

        // 重置介面
        imageWrapper.style.display = 'none';
        saveBtn.style.display = 'none';
        progressBar.style.display = 'block';
        progressFill.style.width = '0%';
        status.innerText = "⏳ 正在啟動 AI 引擎 (首次需下載約 40MB，請稍候)...";
        status.style.color = "#0984e3";

        try {
            // 使用 imgly 提供的全域變數 imglyRemoveBackground
            const config = {
                progress: (key, current, total) => {
                    const percent = Math.round((current / total) * 100);
                    status.innerText = `下載模型中... ${percent}%`;
                    progressFill.style.width = `${percent}%`;
                    if (percent === 100) {
                        status.innerText = "⚡ 正在執行去背運算...";
                    }
                }
            };

            const blob = await imglyRemoveBackground(file, config);

            // 處理結果
            const url = URL.createObjectURL(blob);
            outputImage.src = url;
            
            downloadLink.href = url;
            downloadLink.download = `nobg_${Date.now()}.png`;

            // 更新介面
            progressBar.style.display = 'none';
            status.innerText = "✅ 去背完成！";
            status.style.color = "#00b894";
            imageWrapper.style.display = 'block';
            saveBtn.style.display = 'inline-block';

        } catch (error) {
            console.error("去背失敗:", error);
            progressBar.style.display = 'none';
            status.innerText = "❌ 處理失敗，請嘗試使用較小的圖片或重新整理網頁。";
            status.style.color = "#d63031";
        }
    }
</script>

</body>
</html>
